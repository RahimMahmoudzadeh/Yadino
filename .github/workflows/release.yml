name: Create Release Notes

on:
  push:
    tags:
      - 'v*' # Triggers on any tag starting with 'v' (e.g., v1.6.7)

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
      issues: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necessary to find the previous tag

      - name: Generate Release Body
        id: generate_body
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const currentTag = context.ref.replace('refs/tags/', '');
            
            // 1. Get all tags to find the previous one
            const tags = execSync('git tag --sort=-v:refname').toString().split('\n').filter(t => t);
            const prevTag = tags[1]; // The tag before the one just pushed

            console.log(`Comparing ${prevTag} to ${currentTag}`);

            let body = `## ðŸš€ Release ${currentTag}\n\n`;
            
            // 2. Get the list of commits between tags
            // We look for merged PRs which usually follow the "Merge pull request #XX" format
            const comparison = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: prevTag,
              head: currentTag,
            });

            const processedIssues = new Set();
            let issueList = "### Fixed Issues & Improvements\n";

            for (const commit of comparison.data.commits) {
              // Extract PR number from merge commits or squash commits
              // Matches patterns like "(#123)" or "Merge pull request #123"
              const prMatch = commit.commit.message.match(/#(\d+)/);
              if (prMatch) {
                const prNumber = prMatch[1];
            
                if (!processedIssues.has(prNumber)) {
                  try {
                    const { data: pr } = await github.rest.pulls.get({
                      owner,
                      repo,
                      pull_number: prNumber,
                    });

                    issueList += `* [#${pr.number}] ${pr.title} - **Fixed by @${pr.user.login}**\n`;
                    processedIssues.add(prNumber);
                  } catch (e) {
                    console.log(`Could not fetch PR #${prNumber}: ${e.message}`);
                  }
                }
              }
            }

            if (processedIssues.size === 0) {
              issueList += "_No specific issues identified for this release._";
            }

            core.setOutput('body', body + issueList);

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.generate_body.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}